<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM-1000 | Agent Orchestrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Jacquard font for logo, Press Start 2P for pixel text -->
    <link href="https://fonts.googleapis.com/css2?family=Jacquard+24&family=Press+Start+2P&family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --terminal-green: #00ff41;
            --terminal-green-dim: #00cc33;
            --terminal-green-dark: #003300;
            --terminal-amber: #ffb000;
            --terminal-red: #ff0040;
            --terminal-cyan: #00ffff;
            --terminal-magenta: #ff00ff;
            --bg-dark: #000000;
            --bg-panel: #050505;
            --border-green: #0a2a0a;
        }

        * {
            font-family: 'VT323', monospace;
            box-sizing: border-box;
        }

        .font-pixel { font-family: 'Press Start 2P', cursive; }
        .font-jacquard { font-family: 'Jacquard 24', serif; }
        .font-mono { font-family: 'Share Tech Mono', monospace; }

        body {
            background: var(--bg-dark);
            color: var(--terminal-green);
            overflow: hidden;
        }

        /* Starry background */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: var(--min-opacity); }
            50% { opacity: var(--max-opacity); }
        }

        /* Scanline effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
        }

        /* CRT glow effect */
        .crt-glow {
            text-shadow: 0 0 5px var(--terminal-green), 0 0 10px var(--terminal-green-dim);
        }

        /* Panel styling */
        .terminal-panel {
            background: linear-gradient(180deg, rgba(0, 8, 0, 0.95) 0%, rgba(0, 4, 0, 0.98) 100%);
            border: 1px solid var(--terminal-green-dim);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.15), inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .terminal-panel-header {
            background: linear-gradient(90deg, var(--terminal-green-dark) 0%, transparent 100%);
            border-bottom: 1px solid var(--terminal-green-dim);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--terminal-green-dark); border: 1px solid var(--terminal-green-dim); }
        ::-webkit-scrollbar-thumb:hover { background: var(--terminal-green-dim); }

        /* Task cards */
        .task-card {
            background: rgba(0, 26, 0, 0.8);
            border: 1px solid var(--terminal-green-dark);
            transition: all 0.2s ease;
        }
        .task-card:hover {
            border-color: var(--terminal-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
            transform: translateY(-2px);
        }

        /* Agent status indicators */
        .status-idle {
            background: var(--terminal-green-dark);
            box-shadow: 0 0 5px var(--terminal-green-dark);
        }
        .status-working {
            background: var(--terminal-green);
            box-shadow: 0 0 10px var(--terminal-green);
            animation: pulse-green 1.5s infinite;
        }
        .status-blocked {
            background: var(--terminal-red);
            box-shadow: 0 0 10px var(--terminal-red);
            animation: pulse-red 0.8s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--terminal-green); }
            50% { opacity: 0.6; box-shadow: 0 0 20px var(--terminal-green); }
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Input styling */
        .terminal-input {
            background: rgba(0, 13, 0, 0.8);
            border: 1px solid var(--terminal-green-dark);
            color: var(--terminal-green);
            caret-color: var(--terminal-green);
        }
        .terminal-input:focus {
            outline: none;
            border-color: var(--terminal-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        .terminal-input::placeholder {
            color: var(--terminal-green-dark);
        }

        /* Button styling */
        .terminal-btn {
            background: var(--terminal-green-dark);
            border: 1px solid var(--terminal-green-dim);
            color: var(--terminal-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }
        .terminal-btn:hover {
            background: var(--terminal-green-dim);
            color: var(--bg-dark);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        }

        .terminal-btn-amber {
            border-color: var(--terminal-amber);
            color: var(--terminal-amber);
        }
        .terminal-btn-amber:hover {
            background: var(--terminal-amber);
            color: var(--bg-dark);
            box-shadow: 0 0 15px rgba(255, 176, 0, 0.5);
        }

        /* Progress bar */
        .progress-bar {
            background: var(--terminal-green-dark);
            height: 4px;
        }
        .progress-fill {
            background: var(--terminal-green);
            box-shadow: 0 0 10px var(--terminal-green);
            transition: width 0.5s ease;
        }

        /* Blinking cursor */
        .cursor-blink::after {
            content: '_';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Matrix rain effect for PM thinking */
        .matrix-bg {
            background: linear-gradient(180deg,
                rgba(0, 255, 65, 0.1) 0%,
                rgba(0, 0, 0, 0) 100%
            );
        }

        /* Category colors - all green shades */
        .cat-discovery { color: #00ff88; border-color: #00ff88; }
        .cat-architecture { color: #00ffcc; border-color: #00ffcc; }
        .cat-backend { color: #00ff41; border-color: #00ff41; }
        .cat-frontend { color: #88ff00; border-color: #88ff00; }
        .cat-data { color: #ff00ff; border-color: #ff00ff; }
        .cat-quality { color: #ff0040; border-color: #ff0040; }
        .cat-operations { color: #00ffff; border-color: #00ffff; }
        .cat-support { color: #ffb000; border-color: #ffb000; }

        /* Kanban column header colors */
        .col-backlog { border-top: 2px solid #666; }
        .col-planning { border-top: 2px solid var(--terminal-magenta); }
        .col-in_progress { border-top: 2px solid var(--terminal-cyan); }
        .col-review { border-top: 2px solid var(--terminal-amber); }
        .col-done { border-top: 2px solid var(--terminal-green); }

        /* Logo animation */
        .logo-glow {
            animation: logo-pulse 3s ease-in-out infinite;
        }
        @keyframes logo-pulse {
            0%, 100% {
                text-shadow: 0 0 10px var(--terminal-green), 0 0 20px var(--terminal-green), 0 0 30px var(--terminal-green);
            }
            50% {
                text-shadow: 0 0 20px var(--terminal-green), 0 0 40px var(--terminal-green), 0 0 60px var(--terminal-green);
            }
        }

        /* Grid pattern overlay */
        .grid-overlay {
            background-image:
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* View toggle active state */
        .view-active {
            background: var(--terminal-green) !important;
            color: var(--bg-dark) !important;
            box-shadow: 0 0 10px var(--terminal-green);
        }

        /* Node graph styles */
        .node-graph-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto !important;
            overflow-y: scroll !important;
            background: #000;
        }

        .graph-canvas {
            position: relative;
            width: 100%;
            min-height: 1200px;
            padding: 15px;
            padding-bottom: 50px;
        }

        .node {
            position: absolute;
            border: 2px solid var(--terminal-green);
            background: rgba(0, 20, 0, 0.95);
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .node:hover {
            border-color: #00ff88;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.6);
            transform: scale(1.08);
            z-index: 100;
        }

        .node.node-pm {
            border-color: #00ffff;
            background: rgba(0, 30, 30, 0.98);
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
            border-width: 3px;
        }

        .node.node-capability {
            border-color: #ff00ff;
            background: rgba(30, 0, 30, 0.98);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
        }

        .node.node-agent {
            font-size: 11px;
            min-width: 90px;
        }

        .node.node-selected {
            border-color: #ffff00 !important;
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.7) !important;
            z-index: 99;
        }

        .node.node-working {
            animation: node-working-pulse 0.8s ease-in-out infinite;
            border-color: #00ff41 !important;
            box-shadow: 0 0 35px rgba(0, 255, 65, 0.8) !important;
        }

        .node.node-working::before {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid #00ff41;
            animation: node-ring-pulse 1s ease-out infinite;
            pointer-events: none;
        }

        @keyframes node-working-pulse {
            0%, 100% {
                background: rgba(0, 40, 0, 0.98);
                transform: scale(1);
            }
            50% {
                background: rgba(0, 60, 0, 0.98);
                transform: scale(1.02);
            }
        }

        @keyframes node-ring-pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        /* Connection lines */
        .connection-line {
            stroke: rgba(0, 255, 65, 0.2);
            stroke-width: 1;
            fill: none;
        }

        .connection-line.active {
            stroke: #00ff41;
            stroke-width: 2;
            stroke-dasharray: 8, 4;
            animation: data-flow 0.5s linear infinite;
        }

        @keyframes data-flow {
            0% { stroke-dashoffset: 12; }
            100% { stroke-dashoffset: 0; }
        }

        /* Category boxes */
        .category-box {
            position: absolute;
            border: 1px solid;
            border-radius: 4px;
            opacity: 0.3;
        }

        .category-label {
            position: absolute;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 1px;
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.8);
        }

        /* Agent IO Panel */
        .io-panel {
            background: rgba(0, 10, 0, 0.98);
            border: 1px solid var(--terminal-green-dim);
            backdrop-filter: blur(10px);
        }

        .io-section {
            border: 1px solid var(--terminal-green-dark);
            background: rgba(0, 0, 0, 0.6);
        }

        .io-code {
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            color: var(--terminal-green);
        }

        /* Brighter text for better legibility */
        .bright-text {
            color: #00ff88;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }

        /* Agent status badge */
        .agent-status-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #000;
        }

        .agent-status-badge.working {
            background: #00ff41;
            animation: badge-pulse 0.5s ease-in-out infinite;
        }

        .agent-status-badge.idle {
            background: #444;
        }

        @keyframes badge-pulse {
            0%, 100% { box-shadow: 0 0 5px #00ff41; }
            50% { box-shadow: 0 0 15px #00ff41, 0 0 25px #00ff41; }
        }
    </style>
</head>
<body class="min-h-screen overflow-hidden">
    <!-- Starfield Background -->
    <div class="starfield" id="starfield"></div>

    <!-- Grid Overlay -->
    <div class="fixed inset-0 grid-overlay pointer-events-none z-0"></div>

    <!-- Scanlines -->
    <div class="scanlines"></div>

    <!-- Main Content -->
    <div class="relative z-10 flex flex-col h-screen">
        <!-- Header -->
        <header class="terminal-panel border-t-0 border-x-0 px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 border-2 border-current flex items-center justify-center relative" style="background: linear-gradient(135deg, rgba(0,255,65,0.1) 0%, transparent 100%);">
                            <span class="font-pixel text-sm crt-glow">PM</span>
                            <div class="absolute -top-1 -right-1 w-3 h-3 bg-current animate-pulse rounded-sm"></div>
                            <div class="absolute -bottom-1 -left-1 w-2 h-2 bg-green-700"></div>
                        </div>
                        <div>
                            <h1 class="font-jacquard text-3xl logo-glow tracking-wider">PM-1000</h1>
                            <p class="font-pixel text-[8px] text-green-500 tracking-widest">HIERARCHICAL AGENT ORCHESTRATOR</p>
                            <p class="text-[10px] text-green-700 mt-0.5">28 Specialists | 5 Capabilities | 1 PM</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- View Toggle -->
                    <div class="flex items-center gap-1 border border-green-900 p-0.5">
                        <button id="view-kanban-btn" onclick="switchView('kanban')" class="terminal-btn px-3 py-1 text-[10px] font-pixel view-active">
                            KANBAN
                        </button>
                        <button id="view-graph-btn" onclick="switchView('graph')" class="terminal-btn px-3 py-1 text-[10px] font-pixel">
                            GRAPH
                        </button>
                    </div>

                    <div class="h-6 w-px bg-green-900"></div>

                    <!-- Project Selector -->
                    <div class="flex items-center gap-2">
                        <span class="text-xs opacity-50">[PROJECT]</span>
                        <select id="project-selector" class="terminal-input px-3 py-1.5 text-sm" onchange="selectProject(this.value)">
                            <option value="">ALL_PROJECTS</option>
                        </select>
                        <button onclick="openNewProjectModal()" class="terminal-btn px-2 py-1.5 text-xs">+NEW</button>
                    </div>

                    <div class="h-6 w-px bg-green-900"></div>

                    <!-- Connection Status -->
                    <div id="connection-status" class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span class="text-xs font-pixel opacity-70">CONNECTING...</span>
                    </div>

                    <button onclick="setupDemo()" class="terminal-btn-amber terminal-btn px-3 py-1.5 text-xs font-pixel">
                        LOAD_DEMO
                    </button>
                    <button onclick="openNewTaskModal()" class="terminal-btn px-3 py-1.5 text-xs font-pixel">
                        +NEW_TASK
                    </button>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar - Agent Panel -->
            <aside class="w-64 terminal-panel border-t-0 border-l-0 overflow-y-auto">
                <div class="terminal-panel-header px-4 py-2">
                    <h2 class="font-pixel text-[10px] tracking-wider">EXECUTION_AGENTS <span class="opacity-50">[28]</span></h2>
                </div>
                <div id="agent-list" class="p-3 space-y-1">
                    <!-- Agents rendered here -->
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-hidden flex flex-col">
                <!-- PM Orchestrator Status Bar -->
                <div id="pm-status-bar" class="terminal-panel border-x-0 px-6 py-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 cursor-pointer" onclick="showPMThinking()">
                            <div id="pm-avatar" class="w-10 h-10 border-2 border-current flex items-center justify-center relative">
                                <span class="font-pixel text-[10px] crt-glow">PM</span>
                                <div id="pm-pulse" class="absolute inset-0 border border-current opacity-0"></div>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-pixel text-[10px]">PM_ORCHESTRATOR</span>
                                    <span id="pm-badge" class="hidden px-2 py-0.5 text-[10px] font-pixel border border-current animate-pulse">PROCESSING</span>
                                </div>
                                <div id="pm-status-text" class="text-sm opacity-70 cursor-blink">IDLE - AWAITING_INSTRUCTIONS</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs opacity-50">&gt;</span>
                            <input type="text" id="goal-input" placeholder="ENTER_GOAL_FOR_PM_TO_PROCESS..."
                                class="terminal-input w-96 px-4 py-2 text-sm"
                                onkeypress="if(event.key==='Enter')submitGoal()">
                            <button onclick="submitGoal()" class="terminal-btn px-4 py-2 text-xs font-pixel">
                                EXECUTE
                            </button>
                        </div>
                    </div>
                    <!-- PM Thinking Preview -->
                    <div id="pm-thinking-preview" class="hidden mt-3 p-3 border border-green-900 matrix-bg">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">▶</span>
                            <div class="flex-1">
                                <div id="pm-thinking-snippet" class="text-sm font-mono opacity-80"></div>
                                <button onclick="showPMThinking()" class="text-xs opacity-50 hover:opacity-100 mt-2">
                                    [VIEW_FULL_PROCESS] →
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kanban Board -->
                <div id="kanban-view" class="flex-1 overflow-x-auto p-4">
                    <div class="flex gap-3 h-full min-w-max">
                        <!-- Backlog -->
                        <div class="w-64 terminal-panel col-backlog flex flex-col">
                            <div class="terminal-panel-header px-3 py-2 flex items-center justify-between">
                                <span class="font-pixel text-[10px]">BACKLOG</span>
                                <span id="count-backlog" class="text-xs opacity-50">[0]</span>
                            </div>
                            <div id="column-backlog" class="flex-1 p-2 space-y-2 overflow-y-auto min-h-[200px]" data-status="backlog">
                            </div>
                        </div>

                        <!-- Planning -->
                        <div class="w-64 terminal-panel col-planning flex flex-col">
                            <div class="terminal-panel-header px-3 py-2 flex items-center justify-between">
                                <span class="font-pixel text-[10px] text-fuchsia-400">PLANNING</span>
                                <span id="count-planning" class="text-xs opacity-50">[0]</span>
                            </div>
                            <div id="column-planning" class="flex-1 p-2 space-y-2 overflow-y-auto min-h-[200px]" data-status="planning">
                            </div>
                        </div>

                        <!-- In Progress -->
                        <div class="w-64 terminal-panel col-in_progress flex flex-col">
                            <div class="terminal-panel-header px-3 py-2 flex items-center justify-between">
                                <span class="font-pixel text-[10px] text-cyan-400">IN_PROGRESS</span>
                                <span id="count-in_progress" class="text-xs opacity-50">[0]</span>
                            </div>
                            <div id="column-in_progress" class="flex-1 p-2 space-y-2 overflow-y-auto min-h-[200px]" data-status="in_progress">
                            </div>
                        </div>

                        <!-- Review -->
                        <div class="w-64 terminal-panel col-review flex flex-col">
                            <div class="terminal-panel-header px-3 py-2 flex items-center justify-between">
                                <span class="font-pixel text-[10px] text-amber-400">REVIEW</span>
                                <span id="count-review" class="text-xs opacity-50">[0]</span>
                            </div>
                            <div id="column-review" class="flex-1 p-2 space-y-2 overflow-y-auto min-h-[200px]" data-status="review">
                            </div>
                        </div>

                        <!-- Done -->
                        <div class="w-64 terminal-panel col-done flex flex-col">
                            <div class="terminal-panel-header px-3 py-2 flex items-center justify-between">
                                <span class="font-pixel text-[10px] text-green-400">COMPLETE</span>
                                <span id="count-done" class="text-xs opacity-50">[0]</span>
                            </div>
                            <div id="column-done" class="flex-1 p-2 space-y-2 overflow-y-auto min-h-[200px]" data-status="done">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graph View -->
                <div id="graph-view" class="flex-1 p-2 hidden overflow-hidden">
                    <div class="terminal-panel h-full flex flex-col overflow-hidden">
                        <div class="terminal-panel-header px-4 py-2 flex items-center justify-between shrink-0">
                            <span class="font-pixel text-[10px] bright-text">AGENT_ARCHITECTURE_MAP</span>
                            <div class="flex items-center gap-4 text-[9px]">
                                <span class="flex items-center gap-1"><span class="w-2 h-2 border border-cyan-400 bg-cyan-900"></span> PM</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 border border-fuchsia-500 bg-fuchsia-900"></span> CAPABILITIES</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 border border-green-500 bg-green-900"></span> AGENTS</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ACTIVE</span>
                            </div>
                        </div>
                        <div id="node-graph" class="node-graph-container flex-1 overflow-auto">
                            <div id="graph-canvas" class="graph-canvas">
                                <svg id="connection-svg" class="absolute inset-0 pointer-events-none" style="z-index: 1; width: 100%; height: 100%;"></svg>
                                <div id="nodes-container" style="z-index: 10;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar - Activity & Terminal -->
            <aside class="w-80 terminal-panel border-t-0 border-r-0 flex flex-col">
                <!-- Autonomy Intelligence Panel -->
                <div id="autonomy-panel" class="border-b border-green-900">
                    <div class="terminal-panel-header px-4 py-2 flex items-center justify-between cursor-pointer" onclick="toggleAutonomyPanel()">
                        <div class="flex items-center gap-2">
                            <span id="autonomy-collapse-icon" class="text-[10px] opacity-70">[-]</span>
                            <h2 class="font-pixel text-[10px] tracking-wider text-amber-400">AUTONOMY_ENGINE</h2>
                        </div>
                        <span id="autonomy-status" class="text-[10px] text-green-400">[READY]</span>
                    </div>
                    <div id="autonomy-content" class="p-3 space-y-3 text-xs">
                        <!-- Force Override Indicator -->
                        <div id="force-override-indicator" class="hidden text-[10px] text-amber-400 bg-amber-900/30 px-2 py-1 rounded border border-amber-700 text-center">
                            FORCED: AUTO
                        </div>
                        <!-- Safety Status -->
                        <div class="flex items-center justify-between">
                            <span class="opacity-70">SAFETY:</span>
                            <span id="safety-status" class="text-green-400">NOMINAL</span>
                        </div>
                        <!-- Active Agent -->
                        <div class="flex items-center justify-between">
                            <span class="opacity-70">AGENT:</span>
                            <select id="coding-agent-select" class="bg-black/50 border border-green-900 px-2 py-1 text-xs">
                                <option value="auto">AUTO_SELECT</option>
                                <option value="glm_haiku">GLM_HAIKU</option>
                                <option value="glm_sonnet">GLM_SONNET</option>
                                <option value="claude_code">CLAUDE_CODE</option>
                            </select>
                        </div>
                        <!-- Agent Usage -->
                        <div class="space-y-1">
                            <div class="flex items-center justify-between">
                                <span class="opacity-70">REQUESTS/HR:</span>
                                <span id="agent-requests-hour">0/100</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="opacity-70">COST_TODAY:</span>
                                <span id="agent-cost-today" class="text-cyan-400">$0.00</span>
                            </div>
                        </div>
                        <!-- Agent Controls -->
                        <div class="flex gap-2 mt-2">
                            <button onclick="forceAgentOverride()" class="flex-1 px-2 py-1 border border-amber-700 bg-amber-900/20 text-amber-400 text-[10px] hover:bg-amber-800/30">
                                FORCE_AGENT
                            </button>
                            <button onclick="resetAgentLimits()" class="flex-1 px-2 py-1 border border-green-700 bg-green-900/20 text-green-400 text-[10px] hover:bg-green-800/30">
                                RESET_LIMITS
                            </button>
                        </div>
                        <!-- Decision Engine Status -->
                        <div class="border-t border-green-900 pt-2 mt-2">
                            <div class="flex items-center justify-between">
                                <span class="opacity-70">DECISIONS:</span>
                                <span id="decision-count">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="opacity-70">DEADLINES:</span>
                                <span id="deadline-count" class="text-amber-400">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claude Code Sessions Panel -->
                <div class="border-b border-green-900">
                    <div class="terminal-panel-header px-4 py-2 flex items-center justify-between">
                        <h2 class="font-pixel text-[10px] tracking-wider text-cyan-400">CLAUDE_CODE_SESSIONS</h2>
                        <span id="cc-session-count" class="text-[10px] opacity-50">[0]</span>
                    </div>
                    <div id="cc-sessions-list" class="max-h-48 overflow-y-auto p-2 space-y-2 text-xs">
                        <div class="text-center opacity-30 py-4">NO_ACTIVE_SESSIONS</div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <div class="terminal-panel-header px-4 py-2">
                        <h2 class="font-pixel text-[10px] tracking-wider">ACTIVITY_LOG</h2>
                    </div>
                    <div id="activity-log" class="flex-1 overflow-y-auto p-3 space-y-2 text-sm">
                    </div>
                </div>

                <!-- Terminal -->
                <div class="h-48 border-t border-green-900">
                    <div class="h-full flex flex-col bg-black/50">
                        <div class="px-3 py-1.5 border-b border-green-900 flex items-center gap-2">
                            <div class="flex gap-1">
                                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                            <span class="font-pixel text-[8px] opacity-50 ml-2">PM_TERMINAL_v4.0</span>
                        </div>
                        <div id="terminal-output" class="flex-1 p-3 overflow-y-auto font-mono text-xs">
                            <div class="text-green-400">╔══════════════════════════════════════════════╗</div>
                            <div class="text-green-400">║  PM-1000 HIERARCHICAL AGENT ORCHESTRATOR     ║</div>
                            <div class="text-green-400">╚══════════════════════════════════════════════╝</div>
                            <div class="opacity-70 mt-2">VERSION 4.0.0 | CAPABILITY-BASED ARCHITECTURE</div>
                            <div class="opacity-50">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>
                            <div class="opacity-50">TIER 1: 5 Planning Capabilities [ONLINE]</div>
                            <div class="opacity-50">TIER 2: PM Orchestrator [READY]</div>
                            <div class="opacity-50">TIER 3: 28 Execution Agents [STANDBY]</div>
                            <div class="opacity-50">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>
                            <div class="text-green-600 mt-1">System initialized. Awaiting task submission...</div>
                            <div class="mt-2">&gt; <span class="opacity-70">SYSTEM_READY</span></div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- New Task Modal -->
    <div id="new-task-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="terminal-panel p-6 w-full max-w-lg mx-4">
            <h3 class="font-pixel text-sm mb-4 crt-glow">CREATE_NEW_TASK</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs opacity-50 mb-1">[TITLE]</label>
                    <input type="text" id="new-task-title" placeholder="TASK_TITLE..."
                        class="terminal-input w-full px-4 py-2">
                </div>
                <div>
                    <label class="block text-xs opacity-50 mb-1">[DESCRIPTION]</label>
                    <textarea id="new-task-description" rows="3" placeholder="TASK_DESCRIPTION..."
                        class="terminal-input w-full px-4 py-2"></textarea>
                </div>
                <div>
                    <label class="block text-xs opacity-50 mb-1">[PRIORITY]</label>
                    <select id="new-task-priority" class="terminal-input w-full px-4 py-2">
                        <option value="low">LOW</option>
                        <option value="medium" selected>MEDIUM</option>
                        <option value="high">HIGH</option>
                        <option value="critical">CRITICAL</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewTaskModal()" class="terminal-btn px-4 py-2 text-xs font-pixel opacity-70">
                    CANCEL
                </button>
                <button onclick="createTask()" class="terminal-btn px-4 py-2 text-xs font-pixel">
                    CREATE_TASK
                </button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="new-project-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="terminal-panel p-6 w-full max-w-lg mx-4">
            <h3 class="font-pixel text-sm mb-4 crt-glow">CREATE_NEW_PROJECT</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs opacity-50 mb-1">[PROJECT_NAME]</label>
                    <input type="text" id="new-project-name" placeholder="PROJECT_NAME..."
                        class="terminal-input w-full px-4 py-2">
                </div>
                <div>
                    <label class="block text-xs opacity-50 mb-1">[DIRECTORY_PATH]</label>
                    <input type="text" id="new-project-directory" placeholder="/path/to/project or ./relative/path"
                        class="terminal-input w-full px-4 py-2">
                    <p class="text-[10px] opacity-40 mt-1">Leave empty to use current working directory</p>
                </div>
                <div>
                    <label class="block text-xs opacity-50 mb-1">[DESCRIPTION]</label>
                    <textarea id="new-project-description" rows="3" placeholder="PROJECT_DESCRIPTION..."
                        class="terminal-input w-full px-4 py-2"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewProjectModal()" class="terminal-btn px-4 py-2 text-xs font-pixel opacity-70">
                    CANCEL
                </button>
                <button onclick="createProject()" class="terminal-btn px-4 py-2 text-xs font-pixel">
                    CREATE_PROJECT
                </button>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="terminal-panel p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between mb-4">
                <h3 id="task-detail-title" class="font-pixel text-sm crt-glow">TASK_DETAILS</h3>
                <button onclick="closeTaskDetailModal()" class="opacity-50 hover:opacity-100">[X]</button>
            </div>
            <div id="task-detail-content" class="space-y-4">
            </div>
        </div>
    </div>

    <!-- Agent Detail Modal -->
    <div id="agent-detail-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="terminal-panel p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between mb-4">
                <h3 id="agent-detail-title" class="font-pixel text-sm crt-glow">AGENT_DETAILS</h3>
                <button onclick="closeAgentDetailModal()" class="opacity-50 hover:opacity-100">[X]</button>
            </div>
            <div id="agent-detail-content" class="space-y-4">
            </div>
        </div>
    </div>

    <!-- PM Thinking Modal -->
    <div id="pm-thinking-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="terminal-panel p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 border-2 border-current flex items-center justify-center">
                        <span class="font-pixel text-[10px]">PM</span>
                    </div>
                    <div>
                        <h3 class="font-pixel text-sm crt-glow">PM_ORCHESTRATOR_PROCESS</h3>
                        <p id="pm-thinking-status" class="text-xs opacity-70">PROCESSING...</p>
                    </div>
                </div>
                <button onclick="closePMThinkingModal()" class="opacity-50 hover:opacity-100">[X]</button>
            </div>
            <div id="pm-thinking-content" class="space-y-4 font-mono text-sm">
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════════════
        // Starfield Generator
        // ═══════════════════════════════════════════════════════════════════════════════
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            const numStars = 200;

            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 2 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                star.style.setProperty('--min-opacity', Math.random() * 0.3);
                star.style.setProperty('--max-opacity', Math.random() * 0.5 + 0.5);
                starfield.appendChild(star);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // State
        // ═══════════════════════════════════════════════════════════════════════════════
        let socket;
        let state = {
            projects: [],
            tasks: [],
            agents: [],
            pm_state: {},
            cc_sessions: [],
        };
        let selectedProjectId = null;
        let currentView = 'kanban';
        let selectedNodeId = null;

        const categoryInfo = {
            discovery: { color: '#00ff88', label: 'DISCOVERY' },
            architecture: { color: '#00ffcc', label: 'ARCHITECTURE' },
            backend: { color: '#00ff41', label: 'BACKEND' },
            frontend: { color: '#88ff00', label: 'FRONTEND' },
            data: { color: '#ff00ff', label: 'DATA_ML' },
            quality: { color: '#ff0040', label: 'QUALITY' },
            operations: { color: '#00ffff', label: 'OPERATIONS' },
            support: { color: '#ffb000', label: 'SUPPORT' },
        };

        const planningCapabilities = [
            { id: 'strategic_analysis', name: 'STRATEGIC_ANALYSIS', desc: 'High-level strategic planning, risk assessment, architecture decisions' },
            { id: 'knowledge_synthesis', name: 'KNOWLEDGE_SYNTHESIS', desc: 'Research synthesis, best practices, industry patterns' },
            { id: 'technical_specification', name: 'TECHNICAL_SPEC', desc: 'Deep technical design, algorithm selection, performance optimization' },
            { id: 'security_review', name: 'SECURITY_REVIEW', desc: 'Security analysis, threat modeling, compliance checking' },
            { id: 'creative_alternatives', name: 'CREATIVE_ALT', desc: 'Unconventional solutions, simplification opportunities' },
        ];

        // ═══════════════════════════════════════════════════════════════════════════════
        // Socket Connection
        // ═══════════════════════════════════════════════════════════════════════════════
        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                updateConnectionStatus(true);
                addTerminalLine('CONNECTED_TO_PM_BACKEND', 'success');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
                addTerminalLine('CONNECTION_LOST', 'error');
            });

            socket.on('state_update', (data) => {
                state = { ...state, ...data };
                renderAll();
            });

            socket.on('activity', (entry) => {
                addActivityEntry(entry);
            });

            socket.on('cc_session_update', (session) => {
                // Update session in state
                const idx = state.cc_sessions.findIndex(s => s.task_id === session.task_id);
                if (idx >= 0) {
                    state.cc_sessions[idx] = session;
                } else {
                    state.cc_sessions.push(session);
                }
                renderCCSessions();
                addTerminalLine(`CC_SESSION_UPDATE: ${session.task_title} [${session.status.toUpperCase()}]`);
            });
        }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            if (connected) {
                el.innerHTML = `
                    <div class="w-2 h-2 rounded-full status-working"></div>
                    <span class="text-xs font-pixel opacity-70">ONLINE</span>
                `;
            } else {
                el.innerHTML = `
                    <div class="w-2 h-2 rounded-full status-blocked"></div>
                    <span class="text-xs font-pixel opacity-70">OFFLINE</span>
                `;
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Rendering
        // ═══════════════════════════════════════════════════════════════════════════════
        function renderAll() {
            renderProjects();
            renderAgents();
            renderTasks();
            renderPMStatus();
            renderCCSessions();
        }

        function renderCCSessions() {
            const container = document.getElementById('cc-sessions-list');
            const countEl = document.getElementById('cc-session-count');
            const sessions = state.cc_sessions || [];

            countEl.textContent = `[${sessions.length}]`;

            if (sessions.length === 0) {
                container.innerHTML = '<div class="text-center opacity-30 py-4">NO_ACTIVE_SESSIONS</div>';
                return;
            }

            container.innerHTML = sessions.map(session => {
                const statusColors = {
                    running: '#00ffff',
                    completed: '#00ff41',
                    failed: '#ff0040',
                };
                const statusIcons = {
                    running: '⚡',
                    completed: '✓',
                    failed: '✗',
                };
                const color = statusColors[session.status] || '#888';
                const icon = statusIcons[session.status] || '•';

                return `
                    <div class="border border-green-900 p-2 hover:border-green-500 cursor-pointer transition"
                         onclick="showCCSessionDetails('${session.task_id}')"
                         style="border-left: 2px solid ${color}">
                        <div class="flex items-center justify-between">
                            <span class="truncate flex-1">${session.task_title.toUpperCase().substring(0, 25)}</span>
                            <span style="color: ${color}">${icon}</span>
                        </div>
                        <div class="flex items-center justify-between mt-1 opacity-50">
                            <span class="text-[10px]">PID: ${session.pid || 'N/A'}</span>
                            <span class="text-[10px]" style="color: ${color}">${session.status.toUpperCase()}</span>
                        </div>
                        ${session.status === 'running' ? `
                            <div class="mt-1 h-1 bg-green-900 rounded overflow-hidden">
                                <div class="h-full bg-cyan-400 animate-pulse" style="width: 60%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function showCCSessionDetails(taskId) {
            const session = state.cc_sessions.find(s => s.task_id === taskId);
            if (!session) return;

            const statusColors = { running: '#00ffff', completed: '#00ff41', failed: '#ff0040' };
            const color = statusColors[session.status] || '#888';

            document.getElementById('task-detail-title').textContent = 'CLAUDE_CODE_SESSION';
            document.getElementById('task-detail-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="border border-green-900 p-3">
                        <div class="text-[10px] opacity-50 mb-1">[STATUS]</div>
                        <span class="text-sm" style="color: ${color}">${session.status.toUpperCase()}</span>
                    </div>
                    <div class="border border-green-900 p-3">
                        <div class="text-[10px] opacity-50 mb-1">[PID]</div>
                        <span class="text-sm">${session.pid || 'N/A'}</span>
                    </div>
                </div>

                <div class="border border-green-900 p-3">
                    <div class="text-[10px] opacity-50 mb-1">[TASK]</div>
                    <p class="text-sm">${session.task_title}</p>
                </div>

                <div class="border border-green-900 p-3">
                    <div class="text-[10px] opacity-50 mb-1">[PROMPT]</div>
                    <p class="text-xs font-mono opacity-80">${session.prompt || 'N/A'}</p>
                </div>

                <div class="border border-green-900 p-3">
                    <div class="text-[10px] opacity-50 mb-1">[WORKING_DIR]</div>
                    <p class="text-xs font-mono">${session.working_dir || '.'}</p>
                </div>

                ${session.output ? `
                    <div class="border border-green-900 p-3">
                        <div class="text-[10px] opacity-50 mb-1">[OUTPUT]</div>
                        <pre class="text-xs font-mono opacity-80 max-h-48 overflow-y-auto whitespace-pre-wrap">${session.output.substring(0, 1000)}${session.output.length > 1000 ? '...' : ''}</pre>
                    </div>
                ` : ''}

                <div class="grid grid-cols-2 gap-4 text-[10px] opacity-50">
                    <div>STARTED: ${new Date(session.started_at).toLocaleTimeString()}</div>
                    ${session.completed_at ? `<div>COMPLETED: ${new Date(session.completed_at).toLocaleTimeString()}</div>` : '<div>RUNNING...</div>'}
                </div>
            `;

            document.getElementById('task-detail-modal').classList.remove('hidden');
            document.getElementById('task-detail-modal').classList.add('flex');
        }

        function renderProjects() {
            const selector = document.getElementById('project-selector');
            const currentValue = selector.value;

            selector.innerHTML = `<option value="">ALL_PROJECTS [${state.tasks.length}]</option>`;
            state.projects.forEach(project => {
                const taskCount = state.tasks.filter(t => t.project_id === project.id).length;
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name.toUpperCase().replace(/ /g, '_')} [${taskCount}]`;
                if (project.id === currentValue) option.selected = true;
                selector.appendChild(option);
            });
        }

        function selectProject(projectId) {
            selectedProjectId = projectId || null;
            renderTasks();
            addTerminalLine(`FILTER: ${projectId ? state.projects.find(p => p.id === projectId)?.name.toUpperCase() : 'ALL_PROJECTS'}`);
        }

        function renderAgents() {
            const container = document.getElementById('agent-list');
            const categories = {};

            state.agents.forEach(agent => {
                const cat = agent.category || 'other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(agent);
            });

            let html = '';
            for (const [category, agents] of Object.entries(categories)) {
                const info = categoryInfo[category] || { color: '#888', label: category.toUpperCase() };
                html += `
                    <div class="mb-3">
                        <div class="font-pixel text-[8px] mb-1 opacity-50" style="color: ${info.color}">${info.label}</div>
                        ${agents.map(agent => renderAgentCard(agent, info.color)).join('')}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderAgentCard(agent, color) {
            const statusClass = `status-${agent.status}`;
            const isWorking = agent.status === 'working';

            return `
                <div class="px-2 py-1.5 border-l-2 mb-1 cursor-pointer hover:bg-green-900/20 transition"
                     style="border-color: ${color}"
                     onclick="showAgentDetails('${agent.id}')">
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full ${statusClass}"></div>
                        <span class="text-xs truncate">${agent.role.toUpperCase().replace(/ /g, '_')}</span>
                    </div>
                    ${isWorking ? `
                        <div class="mt-1 progress-bar rounded-full overflow-hidden">
                            <div class="progress-fill h-full" style="width: ${agent.task_progress}%"></div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderTasks() {
            const columns = ['backlog', 'planning', 'in_progress', 'review', 'done'];
            const filteredTasks = selectedProjectId
                ? state.tasks.filter(t => t.project_id === selectedProjectId)
                : state.tasks;

            columns.forEach(status => {
                const container = document.getElementById(`column-${status}`);
                const tasks_in_column = filteredTasks.filter(t => t.status === status);
                const countEl = document.getElementById(`count-${status}`);

                countEl.textContent = `[${tasks_in_column.length}]`;

                if (tasks_in_column.length === 0) {
                    container.innerHTML = `
                        <div class="text-center opacity-30 text-xs py-8">
                            NO_TASKS
                        </div>
                    `;
                } else {
                    container.innerHTML = tasks_in_column.map(task => renderTaskCard(task)).join('');
                }
            });
        }

        function renderTaskCard(task) {
            const priorityColors = {
                low: '#666',
                medium: '#00ff41',
                high: '#ffb000',
                critical: '#ff0040',
            };
            const pColor = priorityColors[task.priority] || '#666';
            const agent = task.assigned_agent ? state.agents.find(a => a.id === task.assigned_agent) : null;

            return `
                <div class="task-card p-2 cursor-pointer"
                     onclick="showTaskDetails('${task.id}')"
                     draggable="true"
                     ondragstart="onDragStart(event, '${task.id}')"
                     ondragend="onDragEnd(event)">
                    <div class="flex items-start justify-between gap-2 mb-1">
                        <span class="text-xs">${task.title.toUpperCase().replace(/ /g, '_')}</span>
                        <span class="text-[10px] px-1 border" style="color: ${pColor}; border-color: ${pColor}">${task.priority.toUpperCase()}</span>
                    </div>
                    ${agent ? `
                        <div class="flex items-center gap-1 text-[10px] opacity-50">
                            <span>▶</span>
                            <span>${agent.role.split(' ')[0]}</span>
                        </div>
                    ` : ''}
                    <div class="text-[10px] opacity-30 mt-1 font-mono">${task.id}</div>
                </div>
            `;
        }

        function renderPMStatus() {
            const pm = state.pm_state;
            const statusText = document.getElementById('pm-status-text');
            const badge = document.getElementById('pm-badge');
            const thinkingPreview = document.getElementById('pm-thinking-preview');
            const thinkingSnippet = document.getElementById('pm-thinking-snippet');
            const statusBar = document.getElementById('pm-status-bar');

            if (pm.status === 'thinking') {
                badge.classList.remove('hidden');
                badge.textContent = 'ANALYZING';
                badge.style.borderColor = '#ff00ff';
                badge.style.color = '#ff00ff';
                statusText.innerHTML = `<span style="color: #ff00ff">ANALYZING_TASK_COMPLEXITY</span>`;
                statusText.classList.add('cursor-blink');
                if (pm.current_thinking) {
                    thinkingPreview.classList.remove('hidden');
                    thinkingSnippet.textContent = pm.current_thinking.substring(0, 100).toUpperCase() + '...';
                }
            } else if (pm.status === 'planning') {
                badge.classList.remove('hidden');
                badge.textContent = 'PLANNING';
                badge.style.borderColor = '#00ffff';
                badge.style.color = '#00ffff';
                statusText.innerHTML = `<span style="color: #00ffff">GENERATING_EXECUTION_PLAN</span>`;
                thinkingPreview.classList.remove('hidden');
                thinkingSnippet.textContent = 'CREATING_WORK_BREAKDOWN_STRUCTURE...';
            } else if (pm.status === 'dispatching') {
                badge.classList.remove('hidden');
                badge.textContent = 'DISPATCHING';
                badge.style.borderColor = '#00ff41';
                badge.style.color = '#00ff41';
                statusText.innerHTML = `<span style="color: #00ff41">DISPATCHING_TO_AGENTS</span>`;
                thinkingPreview.classList.remove('hidden');
                thinkingSnippet.textContent = 'ASSIGNING_TASKS_TO_EXECUTION_AGENTS...';
            } else if (pm.status === 'monitoring') {
                badge.classList.remove('hidden');
                badge.textContent = 'MONITORING';
                badge.style.borderColor = '#00ff41';
                badge.style.color = '#00ff41';
                const activeCount = (state.cc_sessions || []).filter(s => s.status === 'running').length;
                statusText.innerHTML = `<span style="color: #00ff41">MONITORING_${activeCount}_ACTIVE_AGENTS</span>`;
                thinkingPreview.classList.remove('hidden');
                thinkingSnippet.innerHTML = `
                    <span>Goal: ${(pm.current_goal || 'N/A').substring(0, 50).toUpperCase()}</span>
                    <button onclick="resetPM()" class="ml-4 px-2 py-0.5 border border-amber-500 text-amber-500 text-[10px] hover:bg-amber-500 hover:text-black transition">RESET</button>
                `;
            } else if (pm.status === 'error') {
                badge.classList.remove('hidden');
                badge.textContent = 'ERROR';
                badge.style.borderColor = '#ff0040';
                badge.style.color = '#ff0040';
                statusText.innerHTML = `<span style="color: #ff0040">ERROR_OCCURRED</span>`;
                thinkingPreview.classList.remove('hidden');
                thinkingSnippet.innerHTML = `
                    <span class="text-red-400">${(pm.current_thinking || 'Unknown error').substring(0, 80)}</span>
                    <button onclick="resetPM()" class="ml-4 px-2 py-0.5 border border-amber-500 text-amber-500 text-[10px] hover:bg-amber-500 hover:text-black transition">RESET</button>
                `;
            } else {
                badge.classList.add('hidden');
                thinkingPreview.classList.add('hidden');
                statusText.textContent = 'IDLE - AWAITING_INSTRUCTIONS';
                statusText.classList.remove('cursor-blink');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Activity Log
        // ═══════════════════════════════════════════════════════════════════════════════
        function addActivityEntry(entry) {
            const container = document.getElementById('activity-log');
            const time = new Date(entry.timestamp).toLocaleTimeString('en-US', { hour12: false });

            const actionIcons = {
                task_created: '[+]',
                task_updated: '[~]',
                task_moved: '[>]',
                task_deleted: '[-]',
                agent_dispatched: '[!]',
                agent_completed: '[✓]',
                pm_goal_submitted: '[*]',
                project_created: '[P]',
                demo_setup: '[D]',
            };

            const icon = actionIcons[entry.action] || '[•]';

            const html = `
                <div class="border-l border-green-900 pl-2 py-1">
                    <div class="flex items-center gap-2">
                        <span class="opacity-50">${icon}</span>
                        <span class="text-xs">${entry.action.toUpperCase()}</span>
                        <span class="text-[10px] opacity-30 ml-auto font-mono">${time}</span>
                    </div>
                    <div class="text-[10px] opacity-50">${formatDetails(entry.details)}</div>
                </div>
            `;

            container.insertAdjacentHTML('afterbegin', html);
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function formatDetails(details) {
            if (details.task) return `TASK: ${details.task.title.toUpperCase()}`;
            if (details.task_id) return `ID: ${details.task_id}`;
            if (details.agent_id) return `AGENT: ${details.agent_role || details.agent_id}`;
            if (details.goal) return `GOAL: ${details.goal.substring(0, 30).toUpperCase()}...`;
            if (details.project) return `PROJECT: ${details.project.name.toUpperCase()}`;
            return JSON.stringify(details).substring(0, 40);
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Terminal
        // ═══════════════════════════════════════════════════════════════════════════════
        function addTerminalLine(text, type = 'info') {
            const terminal = document.getElementById('terminal-output');
            const colors = {
                info: 'color: var(--terminal-green)',
                error: 'color: var(--terminal-red)',
                warning: 'color: var(--terminal-amber)',
                success: 'color: var(--terminal-green)',
            };
            const style = colors[type] || colors.info;

            terminal.innerHTML += `<div style="${style}">&gt; ${text}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Drag and Drop
        // ═══════════════════════════════════════════════════════════════════════════════
        let draggedTaskId = null;

        function onDragStart(event, taskId) {
            draggedTaskId = taskId;
            event.target.style.opacity = '0.5';
        }

        function onDragEnd(event) {
            event.target.style.opacity = '1';
            draggedTaskId = null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-status]').forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.style.background = 'rgba(0, 255, 65, 0.1)';
                });

                column.addEventListener('dragleave', () => {
                    column.style.background = '';
                });

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.style.background = '';
                    if (draggedTaskId) {
                        const newStatus = column.dataset.status;
                        moveTask(draggedTaskId, newStatus);
                    }
                });
            });
        });

        // ═══════════════════════════════════════════════════════════════════════════════
        // API Functions
        // ═══════════════════════════════════════════════════════════════════════════════
        async function fetchState() {
            try {
                const res = await fetch('/api/state');
                state = await res.json();
                renderAll();
            } catch (e) {
                console.error('Failed to fetch state:', e);
            }
        }

        async function setupDemo() {
            try {
                await fetch('/api/demo/setup', { method: 'POST' });
                addTerminalLine('DEMO_DATA_LOADED', 'success');
            } catch (e) {
                addTerminalLine('DEMO_LOAD_FAILED', 'error');
            }
        }

        async function createTask() {
            const title = document.getElementById('new-task-title').value;
            const description = document.getElementById('new-task-description').value;
            const priority = document.getElementById('new-task-priority').value;

            if (!title) {
                alert('ERROR: TASK_TITLE_REQUIRED');
                return;
            }

            try {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, priority, project_id: selectedProjectId }),
                });
                closeNewTaskModal();
                addTerminalLine(`TASK_CREATED: ${title.toUpperCase()}`, 'success');
            } catch (e) {
                addTerminalLine('TASK_CREATE_FAILED', 'error');
            }
        }

        async function moveTask(taskId, newStatus) {
            try {
                await fetch(`/api/tasks/${taskId}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });
                addTerminalLine(`TASK_MOVED: ${newStatus.toUpperCase()}`);
            } catch (e) {
                addTerminalLine('TASK_MOVE_FAILED', 'error');
            }
        }

        async function submitGoal() {
            const goal = document.getElementById('goal-input').value;
            if (!goal) return;

            try {
                await fetch('/api/pm/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        goal,
                        project_id: selectedProjectId,
                    }),
                });
                document.getElementById('goal-input').value = '';
                addTerminalLine(`GOAL_SUBMITTED: ${goal.substring(0, 40).toUpperCase()}...`, 'success');
                addTerminalLine('PM-1000 analyzing task...', 'info');
            } catch (e) {
                addTerminalLine('GOAL_SUBMIT_FAILED', 'error');
            }
        }

        async function resetPM() {
            try {
                await fetch('/api/pm/reset', { method: 'POST' });
                addTerminalLine('PM_ORCHESTRATOR_RESET', 'success');
            } catch (e) {
                addTerminalLine('PM_RESET_FAILED', 'error');
            }
        }

        async function createProject() {
            const name = document.getElementById('new-project-name').value;
            const directory = document.getElementById('new-project-directory').value || '.';
            const description = document.getElementById('new-project-description').value;

            if (!name) {
                alert('ERROR: PROJECT_NAME_REQUIRED');
                return;
            }

            try {
                const res = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, directory, description }),
                });
                const project = await res.json();
                closeNewProjectModal();
                addTerminalLine(`PROJECT_CREATED: ${name.toUpperCase()}`, 'success');
                addTerminalLine(`  DIRECTORY: ${directory}`, 'info');
                selectedProjectId = project.id;
                document.getElementById('project-selector').value = project.id;
            } catch (e) {
                addTerminalLine('PROJECT_CREATE_FAILED', 'error');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Modal Functions
        // ═══════════════════════════════════════════════════════════════════════════════
        function openNewTaskModal() {
            document.getElementById('new-task-modal').classList.remove('hidden');
            document.getElementById('new-task-modal').classList.add('flex');
        }

        function closeNewTaskModal() {
            document.getElementById('new-task-modal').classList.add('hidden');
            document.getElementById('new-task-modal').classList.remove('flex');
            document.getElementById('new-task-title').value = '';
            document.getElementById('new-task-description').value = '';
        }

        function openNewProjectModal() {
            document.getElementById('new-project-modal').classList.remove('hidden');
            document.getElementById('new-project-modal').classList.add('flex');
        }

        function closeNewProjectModal() {
            document.getElementById('new-project-modal').classList.add('hidden');
            document.getElementById('new-project-modal').classList.remove('flex');
            document.getElementById('new-project-name').value = '';
            document.getElementById('new-project-directory').value = '';
            document.getElementById('new-project-description').value = '';
        }

        function showTaskDetails(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task) return;

            const agent = task.assigned_agent ? state.agents.find(a => a.id === task.assigned_agent) : null;
            const priorityColors = { low: '#666', medium: '#00ff41', high: '#ffb000', critical: '#ff0040' };
            const pColor = priorityColors[task.priority] || '#666';

            document.getElementById('task-detail-title').textContent = task.title.toUpperCase();
            document.getElementById('task-detail-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="border border-green-900 p-3">
                        <div class="text-[10px] opacity-50 mb-1">[STATUS]</div>
                        <span class="text-sm">${task.status.toUpperCase()}</span>
                    </div>
                    <div class="border border-green-900 p-3">
                        <div class="text-[10px] opacity-50 mb-1">[PRIORITY]</div>
                        <span class="text-sm" style="color: ${pColor}">${task.priority.toUpperCase()}</span>
                    </div>
                </div>

                <div class="border border-green-900 p-3">
                    <div class="text-[10px] opacity-50 mb-1">[DESCRIPTION]</div>
                    <p class="text-sm">${task.description || 'NO_DESCRIPTION'}</p>
                </div>

                <div class="border border-green-900 p-3">
                    <div class="text-[10px] opacity-50 mb-1">[ASSIGNED_AGENT]</div>
                    ${agent ? `
                        <div class="flex items-center gap-2">
                            <span class="text-sm">${agent.role.toUpperCase()}</span>
                            <span class="text-[10px] opacity-50">[${agent.category}]</span>
                        </div>
                    ` : `
                        <p class="text-sm opacity-50">UNASSIGNED</p>
                        <div class="mt-2">
                            <select id="assign-agent-select" class="terminal-input w-full px-3 py-1.5 text-sm">
                                <option value="">SELECT_AGENT...</option>
                                ${state.agents.filter(a => a.status === 'idle').map(a =>
                                    `<option value="${a.id}">${a.role.toUpperCase()} [${a.category}]</option>`
                                ).join('')}
                            </select>
                            <button onclick="assignAgentToTask('${task.id}')"
                                class="terminal-btn mt-2 px-3 py-1.5 text-xs font-pixel w-full">
                                ASSIGN_AGENT
                            </button>
                        </div>
                    `}
                </div>

                <div class="flex justify-between pt-4 border-t border-green-900">
                    <button onclick="deleteTask('${task.id}')"
                        class="terminal-btn px-3 py-1.5 text-xs font-pixel" style="border-color: var(--terminal-red); color: var(--terminal-red)">
                        DELETE_TASK
                    </button>
                    ${task.status !== 'done' ? `
                        <button onclick="moveTaskFromModal('${task.id}', 'done')"
                            class="terminal-btn px-3 py-1.5 text-xs font-pixel">
                            MARK_COMPLETE
                        </button>
                    ` : ''}
                </div>
            `;

            document.getElementById('task-detail-modal').classList.remove('hidden');
            document.getElementById('task-detail-modal').classList.add('flex');
            addTerminalLine(`VIEW_TASK: ${task.title.toUpperCase()}`);
        }

        function closeTaskDetailModal() {
            document.getElementById('task-detail-modal').classList.add('hidden');
            document.getElementById('task-detail-modal').classList.remove('flex');
        }

        function showAgentDetails(agentId) {
            const agent = state.agents.find(a => a.id === agentId);
            if (!agent) return;

            const currentTask = agent.current_task ? state.tasks.find(t => t.id === agent.current_task) : null;
            const info = categoryInfo[agent.category] || { color: '#888', label: agent.category };
            const availableTasks = state.tasks.filter(t => ['backlog', 'planning'].includes(t.status) && !t.assigned_agent);

            document.getElementById('agent-detail-title').textContent = agent.role.toUpperCase();
            document.getElementById('agent-detail-content').innerHTML = `
                <div class="border border-green-900 p-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 border-2 flex items-center justify-center text-2xl font-pixel"
                             style="border-color: ${info.color}; color: ${info.color}">
                            ${agent.role.charAt(0)}
                        </div>
                        <div>
                            <div class="text-xl">${agent.role.toUpperCase()}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs" style="color: ${info.color}">[${info.label}]</span>
                                <span class="flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full status-${agent.status}"></span>
                                    <span class="text-xs opacity-70">${agent.status.toUpperCase()}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                ${currentTask ? `
                    <div class="border border-green-900 p-4">
                        <div class="text-[10px] opacity-50 mb-2">[CURRENT_TASK]</div>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm">${currentTask.title.toUpperCase()}</div>
                                <div class="text-[10px] opacity-50 font-mono">${currentTask.id}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl crt-glow">${agent.task_progress}%</div>
                                <div class="text-[10px] opacity-50">PROGRESS</div>
                            </div>
                        </div>
                        <div class="mt-3 progress-bar rounded-full overflow-hidden h-2">
                            <div class="progress-fill h-full" style="width: ${agent.task_progress}%"></div>
                        </div>
                        <button onclick="completeAgentTask('${agent.id}')"
                            class="terminal-btn mt-4 w-full px-3 py-2 text-xs font-pixel">
                            MARK_COMPLETE
                        </button>
                    </div>
                ` : `
                    <div class="border border-green-900 p-4">
                        <div class="text-[10px] opacity-50 mb-2">[DISPATCH_TASK]</div>
                        ${availableTasks.length > 0 ? `
                            <select id="dispatch-task-select" class="terminal-input w-full px-3 py-1.5 text-sm mb-2">
                                <option value="">SELECT_TASK...</option>
                                ${availableTasks.map(t =>
                                    `<option value="${t.id}">${t.title.toUpperCase()} [${t.priority}]</option>`
                                ).join('')}
                            </select>
                            <button onclick="dispatchTaskToAgent('${agent.id}')"
                                class="terminal-btn w-full px-3 py-2 text-xs font-pixel">
                                DISPATCH_TASK
                            </button>
                        ` : `
                            <p class="text-sm opacity-50">NO_AVAILABLE_TASKS</p>
                        `}
                    </div>
                `}
            `;

            document.getElementById('agent-detail-modal').classList.remove('hidden');
            document.getElementById('agent-detail-modal').classList.add('flex');
            addTerminalLine(`VIEW_AGENT: ${agent.role.toUpperCase()}`);
        }

        function closeAgentDetailModal() {
            document.getElementById('agent-detail-modal').classList.add('hidden');
            document.getElementById('agent-detail-modal').classList.remove('flex');
        }

        function closePMThinkingModal() {
            document.getElementById('pm-thinking-modal').classList.add('hidden');
            document.getElementById('pm-thinking-modal').classList.remove('flex');
        }

        function showPMThinking() {
            const pm = state.pm_state;
            const statusEl = document.getElementById('pm-thinking-status');
            const contentEl = document.getElementById('pm-thinking-content');

            const statusMessages = {
                idle: 'AWAITING_INSTRUCTIONS',
                thinking: 'ANALYZING_TASK_COMPLEXITY...',
                planning: 'GENERATING_EXECUTION_PLAN...',
                dispatching: 'ASSIGNING_TO_AGENTS...'
            };

            statusEl.textContent = statusMessages[pm.status] || pm.status.toUpperCase();

            let content = '';
            if (pm.status === 'idle') {
                content = `
                    <div class="text-center py-8 opacity-50">
                        <div class="text-4xl mb-4">▶</div>
                        <div>NO_ACTIVE_PROCESS</div>
                        <div class="text-xs mt-2">SUBMIT_GOAL_TO_BEGIN</div>
                    </div>
                `;
            } else {
                if (pm.current_thinking) {
                    content += `
                        <div class="border-l-2 border-fuchsia-500 p-4 bg-fuchsia-900/10">
                            <div class="text-[10px] text-fuchsia-400 mb-2">[THINKING_BLOCK]</div>
                            <pre class="whitespace-pre-wrap opacity-80">${pm.current_thinking.toUpperCase()}</pre>
                        </div>
                    `;
                }
                if (pm.current_plan) {
                    content += `
                        <div class="border-l-2 border-cyan-500 p-4 bg-cyan-900/10 mt-4">
                            <div class="text-[10px] text-cyan-400 mb-2">[EXECUTION_PLAN]</div>
                            <pre class="whitespace-pre-wrap opacity-80">${pm.current_plan}</pre>
                        </div>
                    `;
                }
                if (pm.dispatched_tasks && pm.dispatched_tasks.length > 0) {
                    content += `
                        <div class="border-l-2 border-green-500 p-4 bg-green-900/10 mt-4">
                            <div class="text-[10px] text-green-400 mb-2">[DISPATCHED_TASKS]</div>
                            ${pm.dispatched_tasks.map(d => `
                                <div class="flex items-center gap-2 text-sm">
                                    <span>▶</span>
                                    <span>${d.task}</span>
                                    <span class="opacity-50">→</span>
                                    <span style="color: var(--terminal-cyan)">${d.agent}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                if (['thinking', 'planning', 'dispatching'].includes(pm.status)) {
                    content += `
                        <div class="flex items-center justify-center gap-2 mt-4 opacity-50">
                            <span class="animate-pulse">▶</span>
                            <span>PROCESSING...</span>
                        </div>
                    `;
                }
            }

            contentEl.innerHTML = content;
            document.getElementById('pm-thinking-modal').classList.remove('hidden');
            document.getElementById('pm-thinking-modal').classList.add('flex');
        }

        async function assignAgentToTask(taskId) {
            const agentId = document.getElementById('assign-agent-select').value;
            if (!agentId) { alert('SELECT_AGENT_FIRST'); return; }
            try {
                await fetch(`/api/agents/${agentId}/dispatch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId }),
                });
                closeTaskDetailModal();
                addTerminalLine(`AGENT_DISPATCHED`, 'success');
            } catch (e) {
                addTerminalLine('DISPATCH_FAILED', 'error');
            }
        }

        async function dispatchTaskToAgent(agentId) {
            const taskId = document.getElementById('dispatch-task-select').value;
            if (!taskId) { alert('SELECT_TASK_FIRST'); return; }
            try {
                await fetch(`/api/agents/${agentId}/dispatch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId }),
                });
                closeAgentDetailModal();
                addTerminalLine(`TASK_DISPATCHED`, 'success');
            } catch (e) {
                addTerminalLine('DISPATCH_FAILED', 'error');
            }
        }

        async function completeAgentTask(agentId) {
            try {
                await fetch(`/api/agents/${agentId}/complete`, { method: 'POST' });
                closeAgentDetailModal();
                addTerminalLine(`TASK_COMPLETED`, 'success');
            } catch (e) {
                addTerminalLine('COMPLETE_FAILED', 'error');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('CONFIRM_DELETE_TASK?')) return;
            try {
                await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                closeTaskDetailModal();
                addTerminalLine(`TASK_DELETED`);
            } catch (e) {
                addTerminalLine('DELETE_FAILED', 'error');
            }
        }

        async function moveTaskFromModal(taskId, newStatus) {
            try {
                await fetch(`/api/tasks/${taskId}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });
                closeTaskDetailModal();
                addTerminalLine(`TASK_STATUS: ${newStatus.toUpperCase()}`);
            } catch (e) {
                addTerminalLine('MOVE_FAILED', 'error');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // View Switching
        // ═══════════════════════════════════════════════════════════════════════════════
        function switchView(view) {
            currentView = view;
            const kanbanView = document.getElementById('kanban-view');
            const graphView = document.getElementById('graph-view');
            const kanbanBtn = document.getElementById('view-kanban-btn');
            const graphBtn = document.getElementById('view-graph-btn');

            if (view === 'kanban') {
                kanbanView.classList.remove('hidden');
                graphView.classList.add('hidden');
                kanbanBtn.classList.add('view-active');
                graphBtn.classList.remove('view-active');
                addTerminalLine('VIEW: KANBAN_BOARD');
            } else {
                kanbanView.classList.add('hidden');
                graphView.classList.remove('hidden');
                kanbanBtn.classList.remove('view-active');
                graphBtn.classList.add('view-active');
                addTerminalLine('VIEW: AGENT_GRAPH');
                renderNodeGraph();
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Node Graph Rendering
        // ═══════════════════════════════════════════════════════════════════════════════
        function renderNodeGraph() {
            const container = document.getElementById('nodes-container');
            const svg = document.getElementById('connection-svg');
            const canvas = document.getElementById('graph-canvas');
            const graphContainer = document.getElementById('node-graph');

            container.innerHTML = '';
            svg.innerHTML = '';

            // Responsive dimensions based on container
            const containerWidth = graphContainer.clientWidth || 800;
            const canvasWidth = Math.max(containerWidth - 40, 700);
            let canvasHeight = 1200; // Will be adjusted based on content
            canvas.style.width = canvasWidth + 'px';

            const nodes = [];
            const connections = [];

            // ═══════════════════════════════════════════════════════════════════════════════
            // TIER 1: PM Orchestrator at center top
            // ═══════════════════════════════════════════════════════════════════════════════
            const pmNode = {
                id: 'pm',
                type: 'pm',
                label: 'PM-1000',
                sublabel: 'ORCHESTRATOR',
                x: canvasWidth / 2 - 80,
                y: 20,
                width: 160,
                height: 55
            };
            nodes.push(pmNode);

            // ═══════════════════════════════════════════════════════════════════════════════
            // TIER 2: Planning Capabilities row
            // ═══════════════════════════════════════════════════════════════════════════════
            const capWidth = Math.min(120, (canvasWidth - 100) / planningCapabilities.length - 10);
            const capSpacing = 8;
            const totalCapWidth = planningCapabilities.length * capWidth + (planningCapabilities.length - 1) * capSpacing;
            const capStartX = (canvasWidth - totalCapWidth) / 2;
            const capY = 90;

            planningCapabilities.forEach((cap, i) => {
                const node = {
                    id: cap.id,
                    type: 'capability',
                    label: cap.name.replace(/_/g, ' '),
                    x: capStartX + i * (capWidth + capSpacing),
                    y: capY,
                    width: capWidth,
                    height: 45,
                    data: cap
                };
                nodes.push(node);
                connections.push({ from: 'pm', to: cap.id, type: 'tier1' });
            });

            // ═══════════════════════════════════════════════════════════════════════════════
            // TIER 3: Execution Agents by Category
            // ═══════════════════════════════════════════════════════════════════════════════
            const categories = {};
            state.agents.forEach(agent => {
                const cat = agent.category || 'other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(agent);
            });

            // Category order and layout - responsive sizing
            const categoryOrder = ['discovery', 'architecture', 'backend', 'frontend', 'data', 'quality', 'operations', 'support'];
            const agentNodeWidth = Math.min(110, (canvasWidth - 100) / 5);
            const agentNodeHeight = 28;
            const agentSpacingX = 6;
            const agentSpacingY = 6;
            const categoryPadding = 10;
            const categorySpacingY = 12;

            let currentY = 170;

            categoryOrder.forEach((catName, catIndex) => {
                const agents = categories[catName];
                if (!agents || agents.length === 0) return;

                const catInfo = categoryInfo[catName] || { color: '#888', label: catName.toUpperCase() };

                // Calculate category dimensions - responsive agents per row
                const agentsPerRow = Math.min(5, Math.floor((canvasWidth - 80) / (agentNodeWidth + agentSpacingX)));
                const rows = Math.ceil(agents.length / agentsPerRow);
                const rowWidth = Math.min(agents.length, agentsPerRow) * (agentNodeWidth + agentSpacingX) - agentSpacingX;
                const catWidth = rowWidth + categoryPadding * 2;
                const catHeight = rows * (agentNodeHeight + agentSpacingY) - agentSpacingY + categoryPadding * 2 + 25;
                const catX = (canvasWidth - catWidth) / 2;

                // Create category background
                const catNode = {
                    id: `cat_${catName}`,
                    type: 'category',
                    label: catInfo.label,
                    x: catX,
                    y: currentY,
                    width: catWidth,
                    height: catHeight,
                    color: catInfo.color
                };
                nodes.push(catNode);

                // Connect this category to a relevant capability
                const capMapping = {
                    discovery: 'knowledge_synthesis',
                    architecture: 'strategic_analysis',
                    backend: 'technical_specification',
                    frontend: 'technical_specification',
                    data: 'technical_specification',
                    quality: 'security_review',
                    operations: 'strategic_analysis',
                    support: 'creative_alternatives'
                };
                connections.push({
                    from: capMapping[catName] || 'strategic_analysis',
                    to: `cat_${catName}`,
                    color: catInfo.color,
                    type: 'tier2'
                });

                // Create agent nodes within category
                agents.forEach((agent, agentIndex) => {
                    const col = agentIndex % agentsPerRow;
                    const row = Math.floor(agentIndex / agentsPerRow);
                    const agentX = catX + categoryPadding + col * (agentNodeWidth + agentSpacingX);
                    const agentY = currentY + 25 + categoryPadding + row * (agentNodeHeight + agentSpacingY);

                    const agentNode = {
                        id: agent.id,
                        type: 'agent',
                        label: agent.role.toUpperCase().replace(/ /g, '_'),
                        x: agentX,
                        y: agentY,
                        width: agentNodeWidth,
                        height: agentNodeHeight,
                        color: catInfo.color,
                        data: agent,
                        status: agent.status
                    };
                    nodes.push(agentNode);
                });

                currentY += catHeight + categorySpacingY;
            });

            // Always set canvas height based on content
            const finalHeight = Math.max(currentY + 80, canvasHeight);
            canvas.style.height = finalHeight + 'px';
            canvas.style.minHeight = finalHeight + 'px';
            svg.setAttribute('width', canvasWidth);
            svg.setAttribute('height', finalHeight);
            svg.setAttribute('viewBox', `0 0 ${canvasWidth} ${finalHeight}`);

            // ═══════════════════════════════════════════════════════════════════════════════
            // Render connections
            // ═══════════════════════════════════════════════════════════════════════════════
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const fromX = fromNode.x + fromNode.width / 2;
                    const fromY = fromNode.y + fromNode.height;
                    const toX = toNode.x + toNode.width / 2;
                    const toY = toNode.y;

                    // Curved bezier line
                    const midY = (fromY + toY) / 2;
                    const path = `M ${fromX} ${fromY} C ${fromX} ${midY}, ${toX} ${midY}, ${toX} ${toY}`;

                    line.setAttribute('d', path);
                    line.setAttribute('class', 'connection-line');

                    if (conn.color) {
                        line.style.stroke = conn.color;
                        line.style.opacity = '0.4';
                    }
                    if (conn.type === 'tier1') {
                        line.style.stroke = '#00ffff';
                        line.style.opacity = '0.5';
                    }
                    line.setAttribute('stroke-dasharray', '6,3');
                    svg.appendChild(line);
                }
            });

            // ═══════════════════════════════════════════════════════════════════════════════
            // Render nodes
            // ═══════════════════════════════════════════════════════════════════════════════
            nodes.forEach(node => {
                if (node.type === 'category') {
                    // Category container box
                    const div = document.createElement('div');
                    div.className = 'category-box';
                    div.style.left = node.x + 'px';
                    div.style.top = node.y + 'px';
                    div.style.width = node.width + 'px';
                    div.style.height = node.height + 'px';
                    div.style.borderColor = node.color;
                    div.style.background = `linear-gradient(180deg, ${node.color}15 0%, ${node.color}05 100%)`;
                    container.appendChild(div);

                    // Category label
                    const label = document.createElement('div');
                    label.className = 'category-label font-pixel';
                    label.style.left = node.x + 'px';
                    label.style.top = (node.y - 2) + 'px';
                    label.style.color = node.color;
                    label.style.borderBottom = `2px solid ${node.color}`;
                    label.textContent = `◆ ${node.label} [${categories[node.label.toLowerCase()]?.length || 0}]`;
                    container.appendChild(label);
                } else {
                    const div = document.createElement('div');
                    div.className = `node node-${node.type}`;
                    div.style.left = node.x + 'px';
                    div.style.top = node.y + 'px';
                    div.style.width = node.width + 'px';
                    div.style.height = node.height + 'px';

                    if (node.color) {
                        div.style.borderColor = node.color;
                        div.style.color = node.color;
                    }

                    const isWorking = node.status === 'working';
                    if (isWorking) {
                        div.classList.add('node-working');
                    }

                    if (selectedNodeId === node.id) {
                        div.classList.add('node-selected');
                    }

                    // Different content based on node type
                    if (node.type === 'pm') {
                        div.innerHTML = `
                            <div class="font-pixel text-sm bright-text">${node.label}</div>
                            <div class="text-[10px] opacity-70">${node.sublabel}</div>
                        `;
                    } else if (node.type === 'capability') {
                        div.innerHTML = `
                            <div class="font-pixel text-[9px] leading-tight">${node.label}</div>
                        `;
                    } else if (node.type === 'agent') {
                        div.innerHTML = `
                            <div class="text-[10px] leading-tight font-bold truncate" title="${node.label}">${node.label}</div>
                            ${isWorking ? '<span class="agent-status-badge working"></span>' : ''}
                        `;
                    }

                    div.onclick = () => selectNode(node);
                    container.appendChild(div);
                }
            });
        }

        function selectNode(node) {
            selectedNodeId = node.id;
            renderNodeGraph(); // Re-render to update selection
            // Show info in terminal
            addTerminalLine(`SELECTED: ${node.label}`);
            if (node.type === 'pm') {
                addTerminalLine(`  TYPE: PM Orchestrator - Task coordination and agent dispatch`);
            } else if (node.type === 'capability') {
                addTerminalLine(`  TYPE: Planning Capability`);
                addTerminalLine(`  DESC: ${node.data?.description || 'Strategic analysis and planning'}`);
            } else if (node.type === 'agent') {
                addTerminalLine(`  TYPE: Execution Agent`);
                addTerminalLine(`  ROLE: ${node.data?.role || node.label}`);
                addTerminalLine(`  STATUS: ${node.status || 'idle'}`);
            }
        }

        // Stub functions - IO panel removed for cleaner layout
        function showIOPanel(node) {
            // Info now shown in terminal via selectNode()
        }

        function closeIOPanel() {
            selectedNodeId = null;
            renderNodeGraph();
        }

        // Helper functions for I/O examples
        function getCapabilityUsage(capId) {
            const usages = {
                strategic_analysis: 'Complex projects, system-wide changes, high-stakes decisions, architectural choices',
                knowledge_synthesis: 'Unknown domains, need for current best practices, evaluation tasks, industry research',
                technical_specification: 'Complex algorithms, database design, API contracts, performance-critical code',
                security_review: 'Auth systems, data handling, external integrations, compliance requirements',
                creative_alternatives: 'Stuck on approach, need fresh perspective, optimization opportunities'
            };
            return usages[capId] || 'General capability usage';
        }

        function getCapabilityRequest(capId) {
            const requests = {
                strategic_analysis: `## Context
Task: Build microservices architecture
Complexity: Level 4 (Enterprise)

## Required Outputs
- Architecture diagram
- Service boundaries
- Communication patterns
- Risk assessment`,
                knowledge_synthesis: `## Research Request
Topic: Modern authentication patterns
Focus: OAuth 2.0 vs JWT comparison
Constraints: Mobile + Web support
Output: Best practices summary`,
                technical_specification: `## Technical Design Request
Component: Real-time messaging
Requirements:
- 10k concurrent connections
- < 100ms latency
- Message persistence`,
                security_review: `## Security Analysis Request
System: User authentication
Concerns:
- Session management
- Password storage
- Rate limiting`,
                creative_alternatives: `## Alternative Solutions Request
Problem: API response times > 2s
Current: Direct DB queries
Constraint: No infrastructure changes`
            };
            return requests[capId] || '## Generic request...';
        }

        function getCapabilityResponse(capId) {
            const responses = {
                strategic_analysis: `## Strategic Plan
Confidence: HIGH

### Phase 1: Core Services
- User Service
- Auth Service
- Gateway

### Risk Assessment
| Risk | Impact | Mitigation |
|------|--------|------------|
| Network latency | HIGH | Circuit breakers |`,
                knowledge_synthesis: `## Research Findings

### Recommendation: JWT + Refresh
- Stateless authentication
- Short-lived access tokens
- Secure refresh rotation

### Trade-offs
✅ Scalability
⚠️ Token size
❌ Revocation complexity`,
                technical_specification: `## Technical Specification

### Architecture
WebSocket + Redis Pub/Sub

### Components
1. Connection Manager
2. Message Router
3. Persistence Layer

### Performance
- 15k concurrent ✓
- 45ms avg latency ✓`,
                security_review: `## Security Assessment

### Findings
1. ⚠️ Session fixation risk
2. ✅ Password hashing (bcrypt)
3. ❌ Missing rate limiting

### Mitigations
- Regenerate session on auth
- Add Redis-based rate limiter`,
                creative_alternatives: `## Alternative Approaches

### Option 1: Redis Cache (Recommended)
- Implementation: 2 days
- Improvement: 80% faster
- Risk: Cache invalidation

### Option 2: Query Optimization
- Implementation: 1 week
- Improvement: 40% faster`
            };
            return responses[capId] || '## Response...';
        }

        function getAgentTasks(agentId) {
            const taskMap = {
                backend_engineer: ['API implementation', 'Business logic', 'Service layer', 'Middleware'],
                frontend_engineer: ['UI components', 'State management', 'Client routing', 'API integration'],
                security_engineer: ['Security audit', 'Penetration testing', 'Vulnerability remediation'],
                database_engineer: ['Query optimization', 'Migrations', 'Indexes', 'Stored procedures'],
                devops_engineer: ['CI/CD pipelines', 'Build automation', 'Container config'],
                qa_engineer: ['Test planning', 'Test case design', 'Manual testing', 'Bug triage'],
            };
            return taskMap[agentId] || ['General implementation tasks'];
        }

        function getAgentUsage(agentId) {
            const usageMap = {
                backend_engineer: 'General server-side code, API endpoints, business rules implementation',
                frontend_engineer: 'General frontend code, component development, UI integration',
                security_engineer: 'Security-sensitive code, compliance requirements, threat modeling',
                database_engineer: 'Database operations, performance tuning, data migrations',
                devops_engineer: 'Deployment automation, pipeline setup, Docker/Kubernetes',
                qa_engineer: 'Test strategy, exploratory testing, release validation',
            };
            return usageMap[agentId] || 'Specialized implementation tasks';
        }

        function getAgentDispatch(agentId) {
            return `<dispatch id="task_1.1">
Agent: ${agentId}
Context: Part of auth system

Task: Implement JWT token generation
and validation middleware

Acceptance Criteria:
- [ ] Token expiry: 15 min
- [ ] Refresh token support
- [ ] Error handling

Timeout: 30 minutes
</dispatch>`;
        }

        function getAgentOutput(agentId) {
            return `## Task Completed

### Files Modified
- src/middleware/auth.js
- src/utils/jwt.js
- tests/auth.test.js

### Summary
Implemented JWT middleware with:
- RS256 signing
- Token refresh endpoint
- Rate limiting integration

### Test Results
✅ 12 tests passing
⚠️ 1 skipped (E2E)`;
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Autonomy Intelligence Panel
        // ═══════════════════════════════════════════════════════════════════════════════
        let autonomyPanelCollapsed = false;
        let autonomyState = {
            safetyStatus: 'NOMINAL',
            activeAgent: 'AUTO_SELECT',
            requestsThisHour: 0,
            maxRequestsHour: 50,
            costToday: 0.00,
            maxCostDaily: 10.00,
            decisionsQueued: 0,
            deadlinesPending: 0,
            forceOverride: null
        };

        function toggleAutonomyPanel() {
            const content = document.getElementById('autonomy-content');
            const icon = document.getElementById('autonomy-collapse-icon');
            autonomyPanelCollapsed = !autonomyPanelCollapsed;

            if (autonomyPanelCollapsed) {
                content.classList.add('hidden');
                icon.textContent = '[+]';
            } else {
                content.classList.remove('hidden');
                icon.textContent = '[-]';
            }
        }

        async function loadAutonomyStatus() {
            try {
                const response = await fetch('/api/autonomy/dashboard');
                if (response.ok) {
                    const data = await response.json();
                    autonomyState = {
                        ...autonomyState,
                        safetyStatus: data.safety?.is_nominal ? 'NOMINAL' : 'ALERT',
                        activeAgent: data.agents?.force_override || data.agents?.default_agent || 'AUTO_SELECT',
                        requestsThisHour: data.agents?.total_requests_hour || 0,
                        maxRequestsHour: data.agents?.max_requests_hour || 50,
                        costToday: data.agents?.total_cost_today || 0.00,
                        maxCostDaily: data.agents?.max_cost_daily || 10.00,
                        decisionsQueued: data.opportunities?.pending_decisions || 0,
                        deadlinesPending: data.temporal?.upcoming_deadlines || 0,
                        forceOverride: data.agents?.force_override
                    };
                    updateAutonomyPanel();
                }
            } catch (e) {
                console.log('Autonomy API not available:', e.message);
            }
        }

        function updateAutonomyPanel() {
            // Safety status
            const safetyEl = document.getElementById('safety-status');
            if (safetyEl) {
                safetyEl.textContent = autonomyState.safetyStatus;
                safetyEl.className = autonomyState.safetyStatus === 'NOMINAL'
                    ? 'text-green-400'
                    : 'text-amber-400';
            }

            // Agent selector
            const agentSelect = document.getElementById('coding-agent-select');
            if (agentSelect && autonomyState.forceOverride) {
                agentSelect.value = autonomyState.forceOverride;
            } else if (agentSelect) {
                agentSelect.value = 'auto';
            }

            // Usage stats
            const requestsEl = document.getElementById('agent-requests-hour');
            if (requestsEl) {
                requestsEl.textContent = `${autonomyState.requestsThisHour}/${autonomyState.maxRequestsHour}`;
                requestsEl.className = autonomyState.requestsThisHour >= autonomyState.maxRequestsHour * 0.8
                    ? 'text-amber-400'
                    : 'text-green-400';
            }

            const costEl = document.getElementById('agent-cost-today');
            if (costEl) {
                costEl.textContent = `$${autonomyState.costToday.toFixed(2)}/$${autonomyState.maxCostDaily.toFixed(2)}`;
                costEl.className = autonomyState.costToday >= autonomyState.maxCostDaily * 0.8
                    ? 'text-amber-400'
                    : 'text-green-400';
            }

            // Decisions and deadlines
            const decisionEl = document.getElementById('decision-count');
            if (decisionEl) {
                decisionEl.textContent = autonomyState.decisionsQueued;
            }

            const deadlineEl = document.getElementById('deadline-count');
            if (deadlineEl) {
                deadlineEl.textContent = autonomyState.deadlinesPending;
            }

            // Force override indicator
            const forceIndicator = document.getElementById('force-override-indicator');
            if (forceIndicator) {
                if (autonomyState.forceOverride) {
                    forceIndicator.classList.remove('hidden');
                    forceIndicator.textContent = `FORCED: ${autonomyState.forceOverride.toUpperCase()}`;
                } else {
                    forceIndicator.classList.add('hidden');
                }
            }
        }

        async function forceAgentOverride() {
            const agentSelect = document.getElementById('coding-agent-select');
            const selectedAgent = agentSelect?.value;

            try {
                if (selectedAgent === 'auto') {
                    // Clear override
                    const response = await fetch('/api/autonomy/agents/force', {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        autonomyState.forceOverride = null;
                        addTerminalLine('AGENT_OVERRIDE: CLEARED → AUTO_SELECT');
                    }
                } else {
                    // Set override
                    const response = await fetch('/api/autonomy/agents/force', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ agent_type: selectedAgent })
                    });
                    if (response.ok) {
                        autonomyState.forceOverride = selectedAgent;
                        addTerminalLine(`AGENT_OVERRIDE: FORCED → ${selectedAgent.toUpperCase()}`);
                    }
                }
                updateAutonomyPanel();
            } catch (e) {
                addTerminalLine(`AGENT_OVERRIDE: FAILED - ${e.message}`, 'error');
            }
        }

        async function resetAgentLimits() {
            try {
                const response = await fetch('/api/autonomy/agents/reset-limits', {
                    method: 'POST'
                });
                if (response.ok) {
                    autonomyState.requestsThisHour = 0;
                    autonomyState.costToday = 0.00;
                    updateAutonomyPanel();
                    addTerminalLine('AGENT_LIMITS: RESET COMPLETE');
                }
            } catch (e) {
                addTerminalLine(`AGENT_LIMITS: RESET FAILED - ${e.message}`, 'error');
            }
        }

        async function updateAgentConfig(agentType, field, value) {
            try {
                const response = await fetch(`/api/autonomy/agents/${agentType}/config`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
                if (response.ok) {
                    addTerminalLine(`AGENT_CONFIG: ${agentType.toUpperCase()}.${field} = ${value}`);
                    await loadAutonomyStatus();
                }
            } catch (e) {
                addTerminalLine(`AGENT_CONFIG: UPDATE FAILED - ${e.message}`, 'error');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // Initialize
        // ═══════════════════════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            createStarfield();
            initSocket();
            fetchState();
            loadAutonomyStatus();
            // Refresh autonomy status every 30 seconds
            setInterval(loadAutonomyStatus, 30000);
        });

        // Re-render graph on window resize
        window.addEventListener('resize', () => {
            if (currentView === 'graph') {
                setTimeout(renderNodeGraph, 100);
            }
        });
    </script>
</body>
</html>
